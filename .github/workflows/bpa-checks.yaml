name: BPA Checks (Semantic Model + Report)

on:
  push:
    branches:
      - "**"

  pull_request:
    branches:
      - "*"

  workflow_dispatch:
    inputs:
      disable_rule_ids:
        description: "Comma-separated rule IDs to disable temporarily (demo). Example: REDUCE_PAGES,ENSURE_PAGES_DO_NOT_SCROLL_VERTICALLY"
        required: false
        default: ""
      skip_bpa:
        description: "Skip all BPA checks (demo)"
        required: false
        type: boolean
        default: false

jobs:
  bpa:
    # If you clicked Run workflow and checked skip_bpa=true, do nothing
    if: ${{ !(github.event_name == 'workflow_dispatch' && inputs.skip_bpa) }}
    runs-on: windows-latest

    env:
      TOOLS_DIR: _tools
      TABULAR_DIR: _tools/TabularEditor
      PBI_DIR: _tools/PBIInspector

      TABULAR_ZIP_URL: https://github.com/TabularEditor/TabularEditor/releases/latest/download/TabularEditor.Portable.zip
      TABULAR_DEFAULT_RULES_URL: https://raw.githubusercontent.com/microsoft/Analysis-Services/master/BestPracticeRules/BPARules.json

      PBI_ZIP_URL: https://github.com/NatVanG/PBI-InspectorV2/releases/latest/download/win-x64-CLI.zip
      PBI_DEFAULT_RULES_URL: https://raw.githubusercontent.com/NatVanG/PBI-InspectorV2/refs/heads/main/Rules/Base-rules.json

      REPO_TABULAR_RULES: bpa-rules-semanticmodel.json
      REPO_PBI_RULES: bpa-rules-report.json

      # Demo: disable rule(s) by ID (comma-separated)
      DISABLE_RULE_IDS: NUMERIC_COLUMN_SUMMARIZE_BY

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Cache BPA tools
        uses: actions/cache@v4
        with:
          path: ${{ env.TOOLS_DIR }}
          key: bpa-tools-v1

      - name: Prepare tools folder
        shell: bash
        run: |
          mkdir -p "${TOOLS_DIR}" "${TABULAR_DIR}" "${PBI_DIR}"

      - name: Download Tabular Editor (if missing)
        shell: bash
        run: |
          set -euo pipefail
          
          if [ ! -f "${TABULAR_DIR}/TabularEditor.exe" ]; then
            echo "Downloading Tabular Editor..."
            curl -L "${TABULAR_ZIP_URL}" -o "${TABULAR_DIR}/TabularEditor.zip"
            unzip -o "${TABULAR_DIR}/TabularEditor.zip" -d "${TABULAR_DIR}"
            rm -f "${TABULAR_DIR}/TabularEditor.zip"
          else
            echo "Tabular Editor already present (cache hit)."
          fi

          if [ ! -f "${TABULAR_DIR}/defaultRules.json" ]; then
            echo "Downloading Tabular Editor default rules..."
            curl -L "${TABULAR_DEFAULT_RULES_URL}" -o "${TABULAR_DIR}/defaultRules.json"
          fi

      - name: Download PBI Inspector (if missing)
        shell: bash
        run: |
          set -euo pipefail

          if [ ! -f "${PBI_DIR}/win-x64/CLI/PBIRInspectorCLI.exe" ]; then
            echo "Downloading PBI Inspector..."
            curl -L "${PBI_ZIP_URL}" -o "${PBI_DIR}/PBIInspector.zip"
            unzip -o "${PBI_DIR}/PBIInspector.zip" -d "${PBI_DIR}"
            rm -f "${PBI_DIR}/PBIInspector.zip"
          else
            echo "PBI Inspector already present (cache hit)."
          fi

          if [ ! -f "${PBI_DIR}/defaultRules.json" ]; then
            echo "Downloading PBI Inspector default rules..."
            curl -L "${PBI_DEFAULT_RULES_URL}" -o "${PBI_DIR}/defaultRules.json"
          fi

      - name: Decide which rules files to use (repo preferred, else defaults)
        id: rules
        shell: bash
        run: |
          set -euo pipefail

          TABULAR_RULES="${REPO_TABULAR_RULES}"
          if [ ! -f "${TABULAR_RULES}" ]; then
            echo "Repo Tabular rules not found; using defaultRules.json"
            TABULAR_RULES="${TABULAR_DIR}/defaultRules.json"
          fi
          echo "Using Tabular rules file: ${RULES}"
          ls -la "${RULES}" || true

          PBI_RULES="${REPO_PBI_RULES}"
          if [ ! -f "${PBI_RULES}" ]; then
            echo "Repo PBI rules not found; using defaultRules.json"
            PBI_RULES="${PBI_DIR}/defaultRules.json"
          fi

          echo "tabularRules=${TABULAR_RULES}" >> "$GITHUB_OUTPUT"
          echo "pbiRules=${PBI_RULES}" >> "$GITHUB_OUTPUT"

          echo "Tabular rules: ${TABULAR_RULES}"
          echo "PBI rules:     ${PBI_RULES}"

      - name: Setup Python (only used to toggle rules for demos)
        if: ${{ env.DISABLE_RULE_IDS != '' }}
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Temporarily disable selected rule IDs (demo)
        if: ${{ env.DISABLE_RULE_IDS != '' }}
        shell: bash
        env:
          DISABLE_RULE_IDS: ${{ env.DISABLE_RULE_IDS }}
          TABULAR_RULES_PATH: ${{ steps.rules.outputs.tabularRules }}
          PBI_RULES_PATH: ${{ steps.rules.outputs.pbiRules }}
        run: |
          set -euo pipefail
          echo "DISABLE_RULE_IDS=$DISABLE_RULE_IDS"
          echo "TABULAR_RULES_PATH=$TABULAR_RULES_PATH"
          echo "PBI_RULES_PATH=$PBI_RULES_PATH"

          python - <<'PY'
          import json, os, re

          ids = [x.strip() for x in os.environ["DISABLE_RULE_IDS"].split(",") if x.strip()]
          tab_path = os.environ["TABULAR_RULES_PATH"]
          pbi_path = os.environ["PBI_RULES_PATH"]

          def disable_in_tabular_rules(path, ids):
            with open(path, "r", encoding="utf-8") as f:
              data = json.load(f)

            changed = 0

            # Case 1: Microsoft BPARules.json style
            if isinstance(data, dict) and "BestPracticeRules" in data and isinstance(data["BestPracticeRules"], list):
              for r in data["BestPracticeRules"]:
                rid = r.get("ID") or r.get("Id") or r.get("id")
                if rid in ids:
                  r["Disabled"] = True
                  changed += 1

            # Case 2: List-of-rules style
            if isinstance(data, list):
              for r in data:
                rid = r.get("ID") or r.get("Id") or r.get("id")
                if rid in ids:
                  r["Disabled"] = True
                  changed += 1

            with open(path, "w", encoding="utf-8") as f:
              json.dump(data, f, indent=2)

            return changed

          def disable_in_pbi_rules(path, ids):
            with open(path, "r", encoding="utf-8") as f:
              data = json.load(f)

            changed = 0
            # PBI Inspector Base-rules.json style: {"rules":[{"id":"...","disabled":false}, ...]}
            if isinstance(data, dict) and "rules" in data and isinstance(data["rules"], list):
              for r in data["rules"]:
                if r.get("id") in ids:
                  r["disabled"] = True
                  changed += 1

            with open(path, "w", encoding="utf-8") as f:
              json.dump(data, f, indent=2)

            return changed

          tab_changed = disable_in_tabular_rules(tab_path, ids)
          pbi_changed = disable_in_pbi_rules(pbi_path, ids)

          print(f"Tabular rules updated: {tab_changed} rule(s) disabled in {tab_path}")
          print(f"PBI rules updated:    {pbi_changed} rule(s) disabled in {pbi_path}")

          # Proof: print any matching rule entries from tabular rules
          with open(tab_path, "r", encoding="utf-8") as f:
            txt = f.read()
          for rid in ids:
            if rid in txt:
              print(f"Proof: found '{rid}' in tabular rules file after patch")
          PY
        env:
          DISABLE_RULE_IDS: ${{ env.DISABLE_RULE_IDS }}
          TABULAR_RULES_PATH: ${{ steps.rules.outputs.tabularRules }}
          PBI_RULES_PATH: ${{ steps.rules.outputs.pbiRules }}

      - name: Run Tabular Editor BPA (Semantic Models)
        shell: bash
        run: |
          set -euo pipefail

          TABULAR_EXE="${TABULAR_DIR}/TabularEditor.exe"
          RULES="${{ steps.rules.outputs.tabularRules }}"

          mapfile -t FILES < <(find . -type f \( -name "*.pbidataset" -o -name "*.pbism" \) | sort)

          if [ "${#FILES[@]}" -eq 0 ]; then
            echo "No .pbidataset/.pbism files found. Skipping Tabular checks."
            exit 0
          fi

          for f in "${FILES[@]}"; do
            dir="$(dirname "$f")"

            if [ -d "${dir}/definition" ]; then
              ITEM_PATH="${dir}/definition"
            elif [ -f "${dir}/model.bim" ]; then
              ITEM_PATH="${dir}/model.bim"
            else
              echo "ERROR: Cannot find semantic model definition for ${f}"
              exit 1
            fi

            echo "Running Tabular Editor BPA on: ${ITEM_PATH}"
            "${TABULAR_EXE}" "${ITEM_PATH}" -A "${RULES}" -G
          done

      - name: Run PBI Inspector BPA (Reports)
        shell: bash
        run: |
          set -euo pipefail

          PBI_EXE="${PBI_DIR}/win-x64/CLI/PBIRInspectorCLI.exe"
          RULES="${{ steps.rules.outputs.pbiRules }}"

          mapfile -t FILES < <(find . -type f -name "*.pbir" | sort)

          if [ "${#FILES[@]}" -eq 0 ]; then
            echo "No .pbir files found. Skipping report checks."
            exit 0
          fi

          for f in "${FILES[@]}"; do
            dir="$(dirname "$f")"

            if [ ! -d "${dir}/definition" ]; then
              echo "WARNING: Missing PBIR definition folder for ${f}. Skipping."
              continue
            fi

            ITEM_PATH="${dir}/definition"
            echo "Running PBI Inspector BPA on: ${ITEM_PATH}"
            "${PBI_EXE}" -pbipreport "${ITEM_PATH}" -rules "${RULES}" -formats "GitHub"
          done
