name: BPA Checks (Semantic Model + Report)

on:
  # Run on ANY push (main + any branch) â€” covers "new branch created" + "any file added/modified"
  push:
    branches:
      - "**"

  # Also run when someone opens/updates a PR into main
  pull_request:
    branches:
      - "*"

  # Manual run button, with demo-friendly inputs
  workflow_dispatch:
    inputs:
      disable_rule_ids:
        description: "Comma-separated rule IDs to disable temporarily (demo). Example: REDUCE_PAGES,ENSURE_PAGES_DO_NOT_SCROLL_VERTICALLY"
        required: false
        default: ""
      skip_bpa:
        description: "Skip all BPA checks (demo)"
        required: false
        type: boolean
        default: false

jobs:
  bpa:
    # If you clicked Run workflow and checked skip_bpa=true, do nothing
    if: ${{ env.DISABLE_RULE_IDS != '' }}
    runs-on: windows-latest

    env:
      TOOLS_DIR: _tools
      TABULAR_DIR: _tools/TabularEditor
      PBI_DIR: _tools/PBIInspector

      TABULAR_ZIP_URL: https://github.com/TabularEditor/TabularEditor/releases/latest/download/TabularEditor.Portable.zip
      TABULAR_DEFAULT_RULES_URL: https://raw.githubusercontent.com/microsoft/Analysis-Services/master/BestPracticeRules/BPARules.json

      PBI_ZIP_URL: https://github.com/NatVanG/PBI-InspectorV2/releases/latest/download/win-x64-CLI.zip
      PBI_DEFAULT_RULES_URL: https://raw.githubusercontent.com/NatVanG/PBI-InspectorV2/refs/heads/main/Rules/Base-rules.json

      REPO_TABULAR_RULES: bpa-rules-semanticmodel.json
      REPO_PBI_RULES: bpa-rules-report.json
      DISABLE_RULE_IDS: NUMERIC_COLUMN_SUMMARIZE_BY

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # Cache the downloaded tools so your workflow is fast after the first run
      - name: Cache BPA tools
        uses: actions/cache@v4
        with:
          path: ${{ env.TOOLS_DIR }}
          key: bpa-tools-v1

      - name: Prepare tools folder
        shell: bash
        run: |
          mkdir -p "${TOOLS_DIR}" "${TABULAR_DIR}" "${PBI_DIR}"

      - name: Download Tabular Editor (if missing)
        shell: bash
        run: |
          set -euo pipefail

          # TabularEditor.exe will exist after unzip
          if [ ! -f "${TABULAR_DIR}/TabularEditor.exe" ]; then
            echo "Downloading Tabular Editor..."
            curl -L "${TABULAR_ZIP_URL}" -o "${TABULAR_DIR}/TabularEditor.zip"
            unzip -o "${TABULAR_DIR}/TabularEditor.zip" -d "${TABULAR_DIR}"
            rm -f "${TABULAR_DIR}/TabularEditor.zip"
          else
            echo "Tabular Editor already present (cache hit)."
          fi

          # Download default rules if missing
          if [ ! -f "${TABULAR_DIR}/defaultRules.json" ]; then
            echo "Downloading Tabular Editor default rules..."
            curl -L "${TABULAR_DEFAULT_RULES_URL}" -o "${TABULAR_DIR}/defaultRules.json"
          fi

      - name: Download PBI Inspector (if missing)
        shell: bash
        run: |
          set -euo pipefail

          # PBIRInspectorCLI.exe will exist after unzip (under win-x64/CLI)
          if [ ! -f "${PBI_DIR}/win-x64/CLI/PBIRInspectorCLI.exe" ]; then
            echo "Downloading PBI Inspector..."
            curl -L "${PBI_ZIP_URL}" -o "${PBI_DIR}/PBIInspector.zip"
            unzip -o "${PBI_DIR}/PBIInspector.zip" -d "${PBI_DIR}"
            rm -f "${PBI_DIR}/PBIInspector.zip"
          else
            echo "PBI Inspector already present (cache hit)."
          fi

          # Download default rules if missing
          if [ ! -f "${PBI_DIR}/defaultRules.json" ]; then
            echo "Downloading PBI Inspector default rules..."
            curl -L "${PBI_DEFAULT_RULES_URL}" -o "${PBI_DIR}/defaultRules.json"
          fi

      - name: Decide which rules files to use (repo preferred, else defaults)
        id: rules
        shell: bash
        run: |
          set -euo pipefail

          TABULAR_RULES="${REPO_TABULAR_RULES}"
          if [ ! -f "${TABULAR_RULES}" ]; then
            echo "Repo Tabular rules not found; using defaultRules.json"
            TABULAR_RULES="${TABULAR_DIR}/defaultRules.json"
          fi

          PBI_RULES="${REPO_PBI_RULES}"
          if [ ! -f "${PBI_RULES}" ]; then
            echo "Repo PBI rules not found; using defaultRules.json"
            PBI_RULES="${PBI_DIR}/defaultRules.json"
          fi

          echo "tabularRules=${TABULAR_RULES}" >> "$GITHUB_OUTPUT"
          echo "pbiRules=${PBI_RULES}" >> "$GITHUB_OUTPUT"

          echo "Tabular rules: ${TABULAR_RULES}"
          echo "PBI rules:     ${PBI_RULES}"

      - name: Setup Python (only used to toggle rules for demos)
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.disable_rule_ids != '' }}id
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Temporarily disable selected rule IDs (demo)
  if: ${{ env.DISABLE_RULE_IDS != '' }}
  shell: bash
  run: |
    set -euo pipefail
    python - <<'PY'
    import json, os

    disable_raw = os.environ.get("DISABLE_RULE_IDS","")
    ids = [x.strip() for x in disable_raw.split(",") if x.strip()]
    if not ids:
      raise SystemExit(0)

    def patch(path: str, ids):
      with open(path, "r", encoding="utf-8") as f:
        data = json.load(f)

      if isinstance(data, dict) and "rules" in data and isinstance(data["rules"], list):
        for r in data["rules"]:
          if r.get("id") in ids:
            r["disabled"] = True

      if isinstance(data, list):
        for r in data:
          if r.get("ID") in ids:
            r["Disabled"] = True
      if isinstance(data, dict) and "BestPracticeRules" in data and isinstance(data["BestPracticeRules"], list):
        for r in data["BestPracticeRules"]:
          if r.get("ID") in ids or r.get("Id") in ids or r.get("id") in ids:
            r["Disabled"] = True

      with open(path, "w", encoding="utf-8") as f:
        json.dump(data, f, indent=2)

      print(f"Disabled {ids} in {path}")

    patch(os.environ["TABULAR_RULES_PATH"], ids)
    patch(os.environ["PBI_RULES_PATH"], ids)
    PY
  env:
    DISABLE_RULE_IDS: ${{ env.DISABLE_RULE_IDS }}
    TABULAR_RULES_PATH: ${{ steps.rules.outputs.tabularRules }}
    PBI_RULES_PATH: ${{ steps.rules.outputs.pbiRules }}


      - name: Run Tabular Editor BPA (Semantic Models)
        shell: bash
        run: |
          set -euo pipefail

          TABULAR_EXE="${TABULAR_DIR}/TabularEditor.exe"
          RULES="${{ steps.rules.outputs.tabularRules }}"

          # Find semantic model item files
          mapfile -t FILES < <(find . -type f \( -name "*.pbidataset" -o -name "*.pbism" \) | sort)

          if [ "${#FILES[@]}" -eq 0 ]; then
            echo "No .pbidataset/.pbism files found. Skipping Tabular checks."
            exit 0
          fi

          for f in "${FILES[@]}"; do
            dir="$(dirname "$f")"

            # Prefer "definition" folder, else "model.bim"
            if [ -d "${dir}/definition" ]; then
              ITEM_PATH="${dir}/definition"
            elif [ -f "${dir}/model.bim" ]; then
              ITEM_PATH="${dir}/model.bim"
            else
              echo "ERROR: Cannot find semantic model definition for ${f}"
              exit 1
            fi

            echo "Running Tabular Editor BPA on: ${ITEM_PATH}"
            "${TABULAR_EXE}" "${ITEM_PATH}" -A "${RULES}" -G
          done

      - name: Run PBI Inspector BPA (Reports)
        shell: bash
        run: |
          set -euo pipefail

          PBI_EXE="${PBI_DIR}/win-x64/CLI/PBIRInspectorCLI.exe"
          RULES="${{ steps.rules.outputs.pbiRules }}"

          mapfile -t FILES < <(find . -type f -name "*.pbir" | sort)

          if [ "${#FILES[@]}" -eq 0 ]; then
            echo "No .pbir files found. Skipping report checks."
            exit 0
          fi

          for f in "${FILES[@]}"; do
            dir="$(dirname "$f")"

            if [ ! -d "${dir}/definition" ]; then
              echo "WARNING: Missing PBIR definition folder for ${f}. Skipping."
              continue
            fi

            ITEM_PATH="${dir}/definition"
            echo "Running PBI Inspector BPA on: ${ITEM_PATH}"
            "${PBI_EXE}" -pbipreport "${ITEM_PATH}" -rules "${RULES}" -formats "GitHub"
          done
